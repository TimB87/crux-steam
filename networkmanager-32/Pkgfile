# Description: Network configuration tool
# URL: https://wiki.gnome.org/Projects/NetworkManager/
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: dhcpcd libndp libnl nss openresolv polkit upower gconf libnewt
# Optional: ppp avahi bash-completion dbus libnl jansson libteam dnsmasq

name=networkmanager-32
version=1.14.4
release=1
source=(
http://ftp.gnome.org/pub/gnome/sources/NetworkManager/${version%.*}/NetworkManager-${version}.tar.xz
disable_wifi_scan_when_connected.patch
)

build() {
  cd NetworkManager-$version

  patch -Np1 -i ../disable_wifi_scan_when_connected.patch
  sed '/initrd/d' -i src/meson.build

  mkdir build
  cd build

  export CC='gcc -m32'
  export PKG_CONFIG_PATH='/usr/lib32/pkgconfig'

  CXXFLAGS+="-O2 -fPIC" \
  meson --prefix /usr \
    --sysconfdir /etc \
    --localstatedir /var \
    --libdir /usr/lib32/NetworkManager \
    --libexecdir /usr/lib32/networkmanager \
    -Ddbus_conf_dir=/usr/share/dbus-1/system.d \
    -Dudev_dir=/lib/udev \
    -Ddhcpcd=/sbin/dhcpcd \
    -Dresolvconf=true \
    -Dconfig_dns_rc_manager_default=resolvconf \
    -Dcrypto=nss \
    -Dintrospection=false \
    -Dsession_tracking_consolekit=false \
    -Dwifi=false \
    -Dwext=false \
    -Dpolkit=no \
    -Dmodify_system=true \
    -Dlibnm_glib=true \
    -Difupdown=false \
    -Dnmtui=false \
    -Dnmcli=false \
    -Dsession_tracking=no \
    -Db_lto=false \
    -Dlibaudit=no \
    -Dlibpsl=false \
    -Dppp=false \
    -Dofono=false \
    -Dselinux=false \
    -Dmodem_manager=false \
    -Dsystemdsystemunitdir=false \
    -Dsystemd_journal=false \
    -Dqt=false \
    -Ddocs=false \
    -Dtests=no \
    -Djson_validation=true \
    -Dovs=false \
    -Dmore_logging=false \
    -Dmore_asserts=0 \
    -Dlibpsl=false \
    ..
  ninja
  mkdir $SRC/install
  DESTDIR=$SRC/install/ ninja install
  install -dm 755 "$PKG"/usr/lib32/{pkgconfig,NetworkManager}
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/libnm.so* "$PKG"/usr/lib32/
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/pkgconfig/libnm.pc "$PKG"/usr/lib32/pkgconfig/
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/libnm-glib.so* "$PKG"/usr/lib32/
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/pkgconfig/libnm-glib.pc "$PKG"/usr/lib32/pkgconfig/
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/libnm-glib-vpn.so* "$PKG"/usr/lib32/
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/pkgconfig/libnm-glib-vpn.pc "$PKG"/usr/lib32/pkgconfig/
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/libnm-util.so* "$PKG"/usr/lib32/
  cp -dr --no-preserve='ownership' $SRC/install/usr/lib32/NetworkManager/pkgconfig/libnm-util.pc "$PKG"/usr/lib32/pkgconfig/
}

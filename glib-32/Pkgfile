# Description: Low-level data structure handling, portability wrappers, and interfaces for runtime functionality
# URL: https://www.gtk.org/
# Maintainer: CRUX compat-32 Team, compat-32-ports at crux dot nu
# Depends on: elfutils-32 glib libffi-32 libpcre-32 util-linux-32

name=glib-32
version=2.60.3
release=1
source=(https://download.gnome.org/sources/glib/${version:0:4}/${name%-*}-$version.tar.xz
	multilib.patch)

build() {
	cd ${name%-*}-$version

	patch -p1 -i $SRC/multilib.patch
  mkdir build && cd build

  CFLAGS+=" -DG_DISABLE_CAST_CHECKS"
  meson --prefix=/usr \
    --libdir=/usr/lib32 \
    --libexecdir=/usr/lib32/ \
    -Dinternal_pcre=true \
    -Dnls=disabled \
    -Dselinux=disabled \
    ..
  ninja
  cd ..
  DESTDIR=$PKG meson install -C build

  python3 -m compileall -d /usr/share/glib-2.0/codegen "$PKG/usr/share/glib-2.0/codegen"
  python3 -O -m compileall -d /usr/share/glib-2.0/codegen "$PKG/usr/share/glib-2.0/codegen"


	rm -r $PKG/usr/{share,include}
	find $PKG/usr/bin -type f -not -name gio-querymodules -printf 'Removing %P\n' -delete
	mv $PKG/usr/bin/gio-querymodules{,-32}

	install -d $PKG/usr/lib32/gio/modules
}
